<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeMirror Fountain Demo</title>
    <style>
      body {
        margin: 0;
        background: #000;
        color: #fff;
        font-family: "Courier New", monospace;
      }

      h1 {
        text-align: center;
        font-size: 2.5rem;
        color: #33ddff;
        margin: 1rem 0;
      }

      main {
        padding: 1rem 2rem;
      }

      .editor {
        height: 80vh;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid #333;
      }

      .cm-editor {
        height: 100%;
      }

      #export-fountain {
        background: #4f8cff;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 24px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 1rem;
      }

      #export-fountain:hover {
        background: #2563eb;
      }
    </style>
  </head>
  <body>
    <h1>Fountain Highlighting Demo</h1>
    <main>
      <button id="export-fountain">Export Fountain</button>
      <div id="editor" class="editor"></div>
    </main>

    <script type="module">
      import { EditorView, keymap } from "@codemirror/view";
      import { EditorState } from "@codemirror/state";
      import {
        defaultKeymap,
        history,
        historyKeymap,
      } from "@codemirror/commands";
      import { lineNumbers } from "@codemirror/view";
      import { syntaxHighlighting, HighlightStyle } from "@codemirror/language";
      import { tags } from "@lezer/highlight";
      import { oneDark } from "@codemirror/theme-one-dark";

      import { fountain } from "./fountain.ts";

      const fountainHighlightStyle = HighlightStyle.define([
        { tag: tags.heading, color: "#4fc1ff", fontWeight: "bold" }, // Scene headings (INT.)
        { tag: tags.keyword, color: "#9e78ff" }, // Transitions
        { tag: tags.strong, color: "#33ddff" }, // Character names
        { tag: tags.string, color: "#ff7b00" }, // Dialogue / string
        { tag: tags.meta, color: "#aaaaaa", fontStyle: "italic" }, // Parentheticals
        { tag: tags.comment, color: "#6272a4" }, // Notes
      ]);

      const doc = `INT./EXT. BLOOM HOUSE - (PRESENT) DAY

The front door opens to reveal Will and Josephine on the porch with their bags. REVERSE to Will's mother Sandra (53), surprised and a little annoyed.

SANDRA
How did you get here?

WILL
We swam. The Atlantic, it's not that big really.`;

      const editorContainer = document.querySelector("#editor");

      if (editorContainer) {
        new EditorView({
          state: EditorState.create({
            doc,
            extensions: [
              lineNumbers(),
              history(),
              keymap.of([...defaultKeymap, ...historyKeymap]),
              fountain(),
              syntaxHighlighting(fountainHighlightStyle),
              oneDark,
            ],
          }),
          parent: editorContainer,
        });
      }

      // Export button
      document
        .getElementById("export-fountain")
        ?.addEventListener("click", () => {
          const text =
            editorContainer.querySelector(".cm-content")?.innerText || "";
          const blob = new Blob([text], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "screenplay.fountain";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
    </script>
  </body>
</html>
